# Data Model: Masonry Gallery Layout

**Feature**: 001-masonry-gallery
**Date**: 2025-11-10
**Status**: Complete

## Overview

The masonry gallery layout feature is primarily a UI/presentation layer enhancement with minimal data model requirements. The data structures focus on image metadata for layout calculations and client-side state management for animations.

## Entities

### ImageMetadata

**Description**: Represents metadata for a single gallery image, used for masonry layout calculations

**Source**: Static JSON file (`static/gallery-metadata.json`), generated at build time from source images

**Lifecycle**:
- Generated: Build time (when images are optimized)
- Loaded: Page load (embedded in HTML or fetched as JSON)
- Updated: Only when images are added/removed/reoptimized

**Fields**:

| Field | Type | Required | Description | Constraints | Example |
|-------|------|----------|-------------|-------------|---------|
| `filename` | string | Yes | Relative path to image file | Valid file path, must exist in static/ | `"images/molly_andrewENG-1.jpg"` |
| `width` | integer | Yes | Original image width in pixels | > 0, typically 1024px after optimization | `1024` |
| `height` | integer | Yes | Original image height in pixels | > 0, varies by aspect ratio | `1466` |
| `aspectRatio` | float | Yes | Width / height ratio | > 0, typically 0.5-2.0 for portrait/landscape | `0.698` |
| `gridRowSpan` | integer | No | CSS Grid row span (legacy, not used in absolute positioning) | > 0 | `11` |

**Validation Rules**:
- `width` and `height` must match actual image dimensions
- `aspectRatio` should equal `width / height` (within rounding tolerance)
- `filename` must correspond to existing image files in multiple formats (AVIF/WebP/JPEG)
- All fields immutable after generation (static metadata)

**Relationships**:
- One-to-many with image files (filename references base name for `-640w`, `-768w`, `-1024w` variants)
- No relationships with other entities (standalone metadata)

**Storage**:
```json
[
  {
    "filename": "images/molly_andrewENG-1.jpg",
    "width": 1024,
    "height": 1466,
    "aspectRatio": 0.6984993178717599,
    "gridRowSpan": 11
  }
]
```

**Notes**:
- File generated by `cmd/photo/photo.go` during image optimization
- Loaded by `internal/handlers/gallery.go` at page render time
- Consumed by `static/js/gallery.js` for layout calculations (via `img width/height` attributes)

---

### GalleryItem (Client-Side State)

**Description**: Runtime representation of a gallery image card in the masonry layout

**Source**: DOM elements created by template, enhanced by JavaScript

**Lifecycle**:
- Created: Page load (from static HTML)
- Positioned: Immediately after creation (before visibility)
- Animated: On scroll intersection (staggered)
- Repositioned: On window resize (responsive adjustment)
- Destroyed: Page unload

**Properties**:

| Property | Type | Description | Managed By | Example |
|----------|------|-------------|------------|---------|
| `index` | integer | Image position in gallery array | Template | `0` (first image) |
| `left` | float (px) | Absolute left position | JavaScript | `348.5` |
| `top` | float (px) | Absolute top position | JavaScript | `1234.2` |
| `width` | float (px) | Container width | JavaScript | `320.5` |
| `height` | float (px) | Container height (preserves aspect ratio) | JavaScript | `458.9` |
| `opacity` | float | Visibility opacity (0-1) | JavaScript | `0` → `1` (animated) |
| `visibility` | string | CSS visibility state | JavaScript | `"hidden"` → `"visible"` |
| `transform` | string | CSS transform for animation | JavaScript | `"translateY(20px)"` → `"translateY(0)"` |

**State Transitions**:

```
[Page Load]
  ↓
[Hidden: opacity=0, visibility=hidden, transform=translateY(20px)]
  ↓
[Positioned: left/top/width/height calculated, visibility=visible]
  ↓
[Intersecting: Detected by Intersection Observer]
  ↓
[Animating: opacity transitions to 1, transform to translateY(0)]
  ↓
[Visible: Animation complete, interactive]
```

**Notes**:
- Not persisted (ephemeral client-side state)
- Recalculated on resize events
- Managed by `GalleryMasonry` class in `static/js/gallery.js`

---

### MasonryColumn (Logical Structure)

**Description**: Virtual column in the masonry layout used for balancing item distribution

**Source**: Calculated at runtime by JavaScript

**Lifecycle**:
- Created: Page load or resize event
- Updated: Each time an item is positioned
- Reset: On column count change (responsive breakpoint)

**Properties**:

| Property | Type | Description | Purpose |
|----------|------|-------------|---------|
| `index` | integer | Column number (0-based) | Identify column position |
| `height` | float (px) | Current cumulative height of items in column | Find shortest column for next item |
| `items` | array | References to GalleryItem elements in this column | Track column contents |

**Algorithm**:
```javascript
// Simplified from gallery.js:203-228
function positionItem(item) {
  // 1. Find shortest column
  let shortestColumn = columnHeights.indexOf(Math.min(...columnHeights));

  // 2. Calculate item position
  const left = shortestColumn * (columnWidth + gap);
  const top = columnHeights[shortestColumn];

  // 3. Position item
  item.style.left = `${left}px`;
  item.style.top = `${top}px`;

  // 4. Update column height
  columnHeights[shortestColumn] += itemHeight + gap;
}
```

**Notes**:
- Not persisted or serialized
- Pure calculation structure (no DOM representation)
- Array implementation: `columnHeights = [0, 0, 0, 0]` (for 4 columns)

---

## Data Flow

### Build Time

```
Source Images (static/images/*.jpg)
  ↓
[Image Optimization Script]
  ↓
Optimized Images (640w, 768w, 1024w in AVIF/WebP/JPEG)
  ↓
[Metadata Generation]
  ↓
gallery-metadata.json
  ↓
[Static Site Build]
  ↓
gallery.html (with width/height attributes embedded)
```

### Runtime (Client)

```
User Loads Page
  ↓
[Parse HTML, DOM Ready]
  ↓
GalleryMasonry.init()
  ↓
[1. Calculate Column Count (responsive)]
  ↓
[2. Position All Items (use declared dimensions)]
  ↓
[3. Set Gallery Height (max column height)]
  ↓
[4. Setup Intersection Observer]
  ↓
[User Scrolls]
  ↓
[Items Enter Viewport]
  ↓
[Staggered Opacity/Transform Animation]
  ↓
[Items Visible & Interactive]
```

### Resize Event

```
Window Resize Detected
  ↓
[Debounce 200ms]
  ↓
[Recalculate Column Count]
  ↓
[If column count changed]
  ↓
[Add smooth transitions]
  ↓
[Reposition all items]
  ↓
[Update gallery height]
  ↓
[Remove transitions after 300ms]
```

## Validation

### Build-Time Validation

**Metadata Generation** (`cmd/photo/photo.go`):
- ✅ Image files must exist and be readable
- ✅ Images must have valid JPEG/PNG headers
- ✅ Width and height must be positive integers
- ✅ Aspect ratio must match width/height calculation

**Static Site Build** (`cmd/build/main.go`):
- ✅ `gallery-metadata.json` must be valid JSON
- ✅ All `filename` references must exist in `static/`
- ✅ Generated HTML must include width/height attributes on all images

### Runtime Validation

**JavaScript Initialization** (`static/js/gallery.js`):
- ✅ Gallery container (`#gallery-masonry`) must exist
- ✅ Gallery items (`.gallery-item`) must exist
- ✅ Images must have `width` and `height` attributes (fallback to naturalWidth/naturalHeight)
- ✅ Column count must be valid (1-4 based on viewport)
- ✅ Calculated dimensions must be positive numbers

**Fallback Behavior**:
- If metadata missing: Use `img.naturalWidth` and `img.naturalHeight` (may cause brief layout shift)
- If gallery element missing: Graceful degradation (no JavaScript enhancements)
- If Intersection Observer unsupported: Items visible immediately (no animations)

## Schema Changes

**None Required**

This feature uses existing data structures:
- `ImageMetadata` struct already defined in `internal/views/gallery.templ:8-15`
- `gallery-metadata.json` already generated by image optimization pipeline
- No database or API changes needed

## Migration Notes

**Not Applicable**

This is a UI enhancement, not a data migration. Existing gallery metadata is compatible.

If metadata is missing or outdated:
```bash
# Regenerate metadata from source images
make optimize-images

# This recreates gallery-metadata.json with correct dimensions
```

## Future Considerations

### Potential Enhancements

1. **Image Captions**: Add `caption` and `alt` fields to ImageMetadata
   - Impact: Requires metadata regeneration, template updates
   - Benefit: Improved accessibility and context

2. **Image Categories**: Add `category` or `tags` fields for filtering
   - Impact: Requires metadata schema change, filter UI
   - Benefit: Large galleries could be organized

3. **Manual Ordering**: Add `order` or `priority` field
   - Impact: Requires metadata schema change, sorting logic
   - Benefit: Curated image order instead of filename-based

**Current Decision**: Not needed for 21-image wedding gallery. Defer until gallery size or complexity increases.

---

## References

- Existing metadata structure: `internal/views/gallery.templ:8-15`
- Metadata file: `static/gallery-metadata.json`
- JavaScript consumption: `static/js/gallery.js:167-229` (positionItem method)
- Build-time generation: `cmd/photo/photo.go` (image optimization script)
